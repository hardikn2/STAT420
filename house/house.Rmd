---
title: "Housing price prediction"
author: "Joseph Juhn (jjuhn2),Olga Scrivner (olgas2), Hardik Naik (hardikn2),Marie Biscarrat (biscarr1)"
output:
  html_document: 
    fig_width: 10
    toc: yes
  pdf_document: default
urlcolor: cyan
---

***

## Team

- Joseph Juhn (jjuhn2)
- Olga Scrivner (olgas2)
- Hardik Naik (hardikn2)
- Marie Biscarrat (biscarr1)

## Title

A tentitive title for this Data Analysis Project is: 

*Housing price prediction*

## Research Statement

We are looking to study how house price ($) can be predicted using various factors, such as the number of bedrooms, view, location, condition etc. This is one of the essential questions asked by almost every family when they decide to buy a new house. The goal of  our model is to help a buyer identify a house price based on their preferred option. 
Dataset: Our data comes from a publicly available dataset “House Sales Prediction” on Kaggle. It consists of 21,613 observation and 21 variables. The price unit is selected as our continuous response value,  expressed in USA $. We did not include ID (we are not considering each house as individual subjects for mixed model), Date (we are not interested in a time series analysis in this analysis), zipcode, latitude and longitude (the data covers only King county). Among our independent variables, we have 3 categorical factors: waterfront (0 and 1), condition (1-5), view (1-4). The price range of our data set is between 75K and  ~8M with a chi-square distribution (positively skewed). 

##Data Preprocessing
Several variable
Methods and Evaluation
We use cor and pair to test for correlation between variables
We use backward BIC to identify a better model


##Introduction
The introduction section should relay what you are attempting to accomplish. It should provide enough background to your work such that a reader would not need to load your data to understand your report. Like the simulation project, you can assume the reader is familiar with the course concepts, but not your data. 
What is this data? Where did it come from? What are the variables? Why is it interesting to you?
Why are you creating a model for this data? What is the goal of this model?

##Preparation
This section should contain any information about data preparation that is performed to the original data before modelling. 
Method
Then you will apply methods seen in class, which may include some of the following but are not limited to:

Multiple linear regression
Dummy variables
Interaction
Residual diagnostics
Outlier diagnostics
Transformations
Polynomial regression
Model selection

## Data


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(MASS)
library(ggplot2)
library(faraway)
```

```{r}
set.seed(1234)
house_data_raw = read.table("kc_house_data.csv", header = T, sep = ",")

house_data_raw = na.omit(house_data_raw)
house_data_base = house_data_raw

house_data_base$bathrooms = mapvalues(house_data_base$bathrooms, from = c(0.75, 1.25,  1.75, 2.25, 2.75, 3.25, 3.75, 4.25, 4.75, 5.25, 5.75, 6.25, 6.75, 7.75), to = c(0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7.5))

house_data_base$floors = mapvalues(house_data_base$floors, from = c(1.5, 2.5, 3.5), to = c(1, 2, 3))

house_data_base$bedrooms_comp = ifelse(house_data_base$bedrooms>6,"6 +", as.character(house_data_base$bedrooms)) 

house_data_base$bathrooms_comp = ifelse(house_data_base$bathrooms>3.5,"3.5 +", as.character(house_data_base$bathrooms)) 

house_data_base$age = ifelse(house_data_base$yr_renovated == 0, 2015 - house_data_base$yr_built, 2015 - house_data_base$yr_renovated)

house_data_base$bedrooms_comp = as.factor(house_data_base$bedrooms_comp)
house_data_base$bathrooms_comp = as.factor(house_data_base$bathrooms_comp)
house_data_base$floors = as.factor(house_data_base$floors)
house_data_base$view = as.factor(house_data_base$view)
house_data_base$waterfront = as.factor(house_data_base$waterfront)
house_data_base$condition = as.factor(house_data_base$condition)
house_data_base$grade = as.factor(house_data_base$grade)

# Remove the variables 
remove = c("id","date","zipcode", "bedrooms", "bathrooms","yr_built", "yr_renovated","sqft_basement")

house_data = house_data_base[ , !(names(house_data_base) %in% remove)]
house_idx = sample(nrow(house_data), 18000)
house_trn = house_data[-house_idx, ]
house_tst = house_data[house_idx, ]


calc_test_rmse = function(model,log=FALSE){
  predictions = ifelse(log, exp(predict(model, house_tst)), predict(model, house_tst))
  sqrt(mean((house_tst$price - predictions) ^ 2))
}

```

```{r}
diagnostics = function(model, pcol = "grey", lcol = "dodgerblue", alpha = 0.05, plotit = TRUE,
                       testit = TRUE) {
  
  if (plotit == TRUE) {
    par(mfrow = c(1, 2))
    
    plot(fitted(model) , resid(model), col = pcol, pch = 20, 
         xlab = "Fitted", ylab = "Residuals", main = "Fitted vs Residuals")
    abline(h = 0, col = lcol, lwd = 2)
    
    qqnorm(resid(model), col = pcol, pch = 20)
    qqline(resid(model), col = lcol, lwd = 2)
  }
  
  if (testit == TRUE) {
    p_val = shapiro.test(resid(model))$p.value
    decision = ifelse(p_val < alpha, "Reject", "Fail to Reject")
    list(p_val = p_val, decision = decision)
  }
}

calc_loocv_rmse = function(model) {
  sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2))
}

```

```{r}
model_additive = lm(price ~ . -grade - bathrooms - bedrooms - yr_built - yr_renovated -sqft_basement -bathrooms_comp -sqft_above, data = house_trn)
summary(model_additive)
car::vif(model_additive)
calc_loocv_rmse(model_additive)
#calc_test_rmse(model_additive)
```

```{r}



model_bic = step(model_additive,trace=0, k= log(length(resid(model_additive))))

summary(model_bic)
calc_loocv_rmse(model_bic)
diagnostics(model_bic)
plot(model_bic)
```

```{r}
model_additive = lm(log(price) ~ sqft_living + floors + waterfront + view + 
    condition + lat + long + sqft_living15 + sqft_lot15 + bedrooms_comp + 
    age, data = house_trn)
summary(model_additive)
car::vif(model_additive)
calc_test_rmse(model_additive,TRUE)
plot(model_additive)
diagnostics(model_additive)

```


```{r}
keep = c("bedrooms" , "sqft_living" , "floors" , "waterfront" , 
    "view" , "condition", "grade" , "yr_built" , "yr_renovated" , "lat" , 
    "long" , "sqft_living15" , "sqft_lot15")
house_data_numeric = house_data_raw
house_data_numeric = house_data_raw[ , (names(house_data_raw) %in% keep)]

#pairs(house_data_numeric)
cor(house_data_numeric)
```


```{r}

model_interactive = lm(price ~ lat + long +(sqft_living + floors + waterfront + view  + sqft_above +  sqft_living15 + sqft_lot15 + age)^2 + bedrooms_comp + bathrooms_comp + condition,data = house_trn)

summary(model_interactive)$adj.r.squared
# model_aic = step(model_interactive,trace=0)
model_aic = stepAIC(model_interactive, direction = "both",trace = FALSE)
calc_test_rmse(model_aic)

# summary(model_aic)
model_bic = step(model_interactive,trace=0, k= log(length(resid(model_interactive))))
summary(model_bic)
calc_test_rmse(model_bic)

```


## Reference

