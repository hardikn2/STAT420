---
title: "Housing price prediction"
author: "Joseph Juhn (jjuhn2),Olga Scrivner (olgas2), Hardik Naik (hardikn2),Marie Biscarrat (biscarr1)"
output:
  html_document: 
    fig_width: 10
    toc: yes
  pdf_document: default
urlcolor: cyan
---

***

## Team

- Joseph Juhn (jjuhn2)
- Olga Scrivner (olgas2)
- Hardik Naik (hardikn2)
- Marie Biscarrat (biscarr1)

## Title

A tentitive title for this Data Analysis Project is: 

*Housing price prediction*

## Research Statement

We are looking to study how house price ($) can be predicted using various factors, such as the number of bedrooms, view, location, condition etc. This is one of the essential questions asked by almost every family when they decide to buy a new house. The goal of  our model is to help a buyer identify a house price based on their preferred option. 
Dataset: Our data comes from a publicly available dataset “House Sales Prediction” on Kaggle. It consists of 21,613 observation and 21 variables. The price unit is selected as our continuous response value,  expressed in USA $. We did not include ID (we are not considering each house as individual subjects for mixed model), Date (we are not interested in a time series analysis in this analysis), zipcode, latitude and longitude (the data covers only King county). Among our independent variables, we have 3 categorical factors: waterfront (0 and 1), condition (1-5), view (1-4). The price range of our data set is between 75K and  ~8M with a chi-square distribution (positively skewed). 

##Data Preprocessing
Several variable
Methods and Evaluation
We use cor and pair to test for correlation between variables
We use backward BIC to identify a better model


##Introduction
The introduction section should relay what you are attempting to accomplish. It should provide enough background to your work such that a reader would not need to load your data to understand your report. Like the simulation project, you can assume the reader is familiar with the course concepts, but not your data. 
What is this data? Where did it come from? What are the variables? Why is it interesting to you?
Why are you creating a model for this data? What is the goal of this model?

##Preparation
This section should contain any information about data preparation that is performed to the original data before modelling. 
Method
Then you will apply methods seen in class, which may include some of the following but are not limited to:

Multiple linear regression
Dummy variables
Interaction
Residual diagnostics
Outlier diagnostics
Transformations
Polynomial regression
Model selection

## Data


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(MASS)
library(ggplot2)
library(faraway)
library(lmtest)
```

```{r}
set.seed(2)
house_data_raw = read.table("kc_house_data.csv", header = T, sep = ",")

house_data_raw = na.omit(house_data_raw)
house_data_base = house_data_raw

house_data_base$bathrooms = mapvalues(house_data_base$bathrooms, from = c(0.75, 1.25,  1.75, 2.25, 2.75, 3.25, 3.75, 4.25, 4.75, 5.25, 5.75, 6.25, 6.75, 7.75), to = c(0.5, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7.5))

house_data_base$floors = mapvalues(house_data_base$floors, from = c(1.5, 2.5, 3.5), to = c(1, 2, 3))

house_data_base$bedrooms_comp = ifelse(house_data_base$bedrooms>6,"6 +", as.character(house_data_base$bedrooms)) 

house_data_base$bathrooms_comp = ifelse(house_data_base$bathrooms>3.5,"3.5 +", as.character(house_data_base$bathrooms)) 

house_data_base$age = ifelse(house_data_base$yr_renovated == 0, 2015 - house_data_base$yr_built, 2015 - house_data_base$yr_renovated)

house_data_base$bedrooms_comp = as.factor(house_data_base$bedrooms_comp)
house_data_base$bathrooms_comp = as.factor(house_data_base$bathrooms_comp)
house_data_base$floors = as.factor(house_data_base$floors)
house_data_base$view = as.factor(house_data_base$view)
house_data_base$waterfront = as.factor(house_data_base$waterfront)
house_data_base$condition = as.factor(house_data_base$condition)
house_data_base$grade = as.factor(house_data_base$grade)

# Remove the variables 
remove = c("id","date","zipcode", "bedrooms", "bathrooms","yr_built", "yr_renovated","sqft_basement")

house_data = house_data_base[ , !(names(house_data_base) %in% remove)]
house_idx = sample(nrow(house_data), 5000)
house_trn = house_data[-house_idx, ]
house_tst = house_data[house_idx, ]

#clean test data to remove outliers and infreqent points
house_tst = house_tst[as.numeric(house_tst$condition) != 1,]
house_tst = house_tst[house_tst$bedrooms_comp != 0,]
house_tst = house_tst[house_tst$price < 2*sd(house_tst$price),]


```


```{r}
calc_test_rmse = function(model,log=FALSE){
  predictions = ifelse(log, exp(predict(model, house_tst)), predict(model, house_tst))
  sqrt(mean((house_tst$price - predictions) ^ 2))
}


diagnostics = function(model, pcol = "grey", lcol = "dodgerblue", alpha = 0.05, plotit = TRUE,
                       testit = FALSE) {
  
  if (plotit == TRUE) {
    par(mfrow = c(1, 2))
    
    plot(fitted(model) , resid(model), col = pcol, pch = 20, 
         xlab = "Fitted", ylab = "Residuals", main = "Fitted vs Residuals")
    abline(h = 0, col = lcol, lwd = 2)
    
    qqnorm(resid(model), col = pcol, pch = 20)
    qqline(resid(model), col = lcol, lwd = 2)
  }
  
  if (testit == TRUE) {
    p_val = shapiro.test(resid(model))$p.value
    decision = ifelse(p_val < alpha, "Reject", "Fail to Reject")
    list(p_val = p_val, decision = decision)
  }
}

calc_loocv_rmse = function(model) {
  sqrt(mean((resid(model) / (1 - hatvalues(model))) ^ 2))
}

```

```{r}
model_additive_basic = lm(price ~ . , data = house_data_raw[-house_idx,])
#car::vif(model_additive_basic)

```

```{r}
summary(model_additive_basic)$adj.r.squared
calc_loocv_rmse(model_additive_basic)
diagnostics(model_additive_basic)
```

```{r}
model_additive_test = lm(price ~ . , data = house_trn)
summary(model_additive_test)$adj.r.squared
#car::vif(model_additive_test)
#calc_loocv_rmse(model_additive_test)
calc_test_rmse(model_additive_test)
diagnostics(model_additive_test)
```
```{r}
# box cox test indicates having lambda closer to 0 would be benefit the model. 
# Although 0 is out of the 95 % confidence interval, It is pretty close and didn't want to use fractional value. 

boxcox(model_additive_test, lambda = seq(-0.05, 0.05, length = 10))

```

```{r}
# Now it is logged. 
# adj.r.square increased yay

model_additive_log = lm(log(price) ~ . , data = house_trn)
summary(model_additive_log)$adj.r.squared
calc_test_rmse(model_additive_log)
diagnostics(model_additive_log)
```
```{r}
car::vif(model_additive_log)
```

```{r}
model_additive_small = lm(log(price) ~ . -bathrooms_comp -grade, data = house_trn)
summary(model_additive_small)$adj.r.squared
car::vif(model_additive_small)
calc_loocv_rmse(model_additive_small)
calc_test_rmse(model_additive_small)
diagnostics(model_additive_small)

anova(model_additive_small, model_additive_log)
```

```{r}
# Testing to see if grade is collinear with other variables
# Although The vif() for the grade came out to be > than 5. It was close to 5 we question collinearity of this variable. 
# hence we checked anova = very low p value reject null which was the grade model. 
# and we did partial correlation coef test 0.3481574 which is not close to 0. 


grade = lm(log(price) ~ .- grade, data = house_trn)
summary(grade)$adj.r.squared
# car::vif(grade)
calc_loocv_rmse(grade)
calc_test_rmse(grade)
diagnostics(grade)

# Partial correlation coefficient test = 0.3481574. 

grade_without_price = lm(grade ~ . - price, data = house_trn)
price_without_grade = lm(log(price) ~ . - grade, data = house_trn)

cor(resid(grade_without_price), resid(price_without_grade))

```

```{r}
# Series of Anova test for grade and bathroom variable. 

# grade = lm(log(price) ~ .-grade, data = house_trn)
# br = lm(log(price) ~ .- bathrooms_comp, data = house_trn)
grade_br = lm(log(price) ~ .-grade - bathrooms_comp, data = house_trn)

# anova(grade, model_additive_log)
# anova(br, model_additive_log)
anova(grade_br, model_additive_log)


```



```{r}
model_bic = step(model_additive_small,trace=0, k= log(length(resid(model_additive_small))))
summary(model_bic)
#$adj.r.squared

calc_loocv_rmse(model_bic)
calc_test_rmse(model_bic)
#diagnostics(model_bic)
car::vif(model_bic)

```

Lets remove sqft_above
```{r}
model_bic_add_new = lm(formula = log(price) ~ (sqft_living + sqft_lot + floors + 
    waterfront + view + condition + lat + 
    long + sqft_living15 + sqft_lot15 + bedrooms_comp + 
    age) , data = house_trn)
summary(model_bic_add_new)$adj.r.squared
diagnostics(model_bic_add_new)
car::vif(model_bic_add_new)
calc_test_rmse(model_bic_add_new)


#

```


```{r}
model_bic_add = lm(log(price) ~ sqft_living + sqft_lot + floors + waterfront + 
    view + condition  + lat + long + sqft_living15 + sqft_lot15 + 
    bedrooms_comp + age, data = house_trn)
summary(model_bic_add)$adj.r.squared

calc_test_rmse(model_bic_add,TRUE)
diagnostics(model_bic_add)
```



```{r}
cd = cooks.distance(model_bic_add)
model_bic_add_cook = lm(log(price) ~ sqft_living + sqft_lot + floors + waterfront + 
    view + condition + grade + lat + long + sqft_living15 + sqft_lot15 + 
    bathrooms_comp + age, data = house_trn, subset = cd <= 4/length(resid(model_bic_add)))

summary(model_bic_add_cook)$adj.r.squared
diagnostics(model_bic_add_cook)
calc_test_rmse(model_bic_add_cook,TRUE)


```



```{r}

```


```{r}
plot(model_bic_add_cook)
# shapiro.test(resid(model_bic_add_cook))
vif(model_bic_add_cook)
bptest(model_bic_add_cook)
table(as.numeric(house_data_base$condition))

```


```{r}


model_interactive = lm(log(price) ~ sqft_living + sqft_lot + floors + waterfront + 
    view + condition + grade + lat + long + sqft_living15 + sqft_lot15 + 
    bathrooms_comp + age, data = house_trn)

summary(model_interactive)$adj.r.squared
# model_aic = step(model_interactive,trace=0)
model_aic = stepAIC(model_interactive, direction = "both",trace = FALSE)
calc_test_rmse(model_aic)

# summary(model_aic)
model_bic = step(model_interactive,trace=0, k= log(length(resid(model_interactive))))
summary(model_bic)$adj.r.squared
calc_test_rmse(model_bic)
plot(model_bic)

```


```{r}
keep = c("bedrooms" , "sqft_living" , "floors" , "waterfront" , 
    "view" , "condition", "grade" , "yr_built" , "yr_renovated" , "lat" , 
    "long" , "sqft_living15" , "sqft_lot15")
house_data_numeric = house_data_raw
house_data_numeric = house_data_raw[ , (names(house_data_raw) %in% keep)]

#pairs(house_data_numeric)
cor(house_data_numeric)
```


## Reference
House Sales in King County [Dataset] (2016) Kaggle. Available at: https://www.kaggle.com/harlfoxem/housesalesprediction [Accessed July 25, 2018].

##extra



